<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Transaction Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h2 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .transaction {
      border: 1px solid #ddd;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .transaction h4 {
      margin: 0 0 10px;
      color: #2c3e50;
    }
    .transaction p {
      margin: 5px 0;
      color: #7f8c8d;
    }
    .status {
      margin-top: 10px;
      font-weight: bold;
    }
    .status.complete {
      color: #27ae60;
    }
    .status.incomplete {
      color: #e74c3c;
    }
    .actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    .actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .complete-btn {
      background-color: #2ecc71;
      color: white;
    }
    .complete-btn:hover {
      background-color: #27ae60;
    }
    .incomplete-btn {
      background-color: #e74c3c;
      color: white;
    }
    .incomplete-btn:hover {
      background-color: #c0392b;
    }
    #transactionContainer {
      max-width: 800px;
      margin: 0 auto;
    }
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>

  <button class="logout-btn" id="logoutBtn">Logout</button>
  <h2>Admin Panel - Manage Transactions</h2>
  
  <div id="transactionContainer">
    <p>Loading transactions...</p>
  </div>

<script>
// Global variable for password
let password = '';

// Check for admin password on page load
document.addEventListener('DOMContentLoaded', function() {
  // Get password from session storage
  password = sessionStorage.getItem('adminPassword');
  
  // If no password found, redirect to login
  if(!password) {
    window.location.href = '../Html/admin-login.html';
    return;
  }
  
  // Set up logout button
  document.getElementById('logoutBtn').addEventListener('click', function() {
    sessionStorage.removeItem('adminPassword');
    window.location.href = '../Html/admin-login.html';
  });
  
  // Load transactions
  DonorRecieved();
});

function DonorRecieved() {
  const container = document.getElementById('transactionContainer');

  fetch("https://donation-site-backend-e100d7fddae1.herokuapp.com/donController/getUnConf", {
    method: "GET",
    headers: {
      "site-admin-pass": password
    }
  })
  .then(response => {
    if (!response.ok) {
      // If unauthorized, clear storage and redirect
      if(response.status === 401) {
        sessionStorage.removeItem('adminPassword');
        window.location.href = '../Html/admin-login.html';
      }
      throw new Error("Failed to fetch data");
    }
    return response.json();
  })
  .then(data => {
    // Process data
    if (data.length === 0) {
      container.innerHTML = "<p>No unconfirmed transactions found.</p>";
      return;
    }

    container.innerHTML = "";
    data.forEach((donation, index) => {
      const transactionDiv = document.createElement('div');
      transactionDiv.className = 'transaction';

      const statusClass = donation.status === 'Complete' ? 'complete' : 'incomplete';
      
      transactionDiv.innerHTML = `
        <h4>Donor: ${donation.donorName || 'Anonymous'}</h4>
        <p>Amount: Rs ${donation.amount || 0}</p>
        <p>Date: ${new Date(donation.date).toLocaleString() || 'Unknown date'}</p>
        <p class="status ${statusClass}" id="status-${index}">Status: ${donation.status || 'Pending'}</p>
        <div class="actions">
          <button class="complete-btn" id="complete-${index}">Mark as Complete</button>
          <button class="incomplete-btn" id="incomplete-${index}">Mark as Incomplete</button>
        </div>
      `;

      container.appendChild(transactionDiv);

      // Attach event listeners
      document.getElementById(`complete-${index}`).addEventListener("click", function() {
        markStatus(donation._id || donation.id, "Complete", index);
      });
      
      document.getElementById(`incomplete-${index}`).addEventListener("click", function() {
        deleteDonor(donation._id || donation.id, index);
      });
    });
  })
  .catch(error => {
    console.error("Error:", error);
    container.innerHTML = `<p>Error loading transactions: ${error.message}</p>`;
  });
}

function markStatus(donationId, newStatus, index) {
  fetch("https://donation-site-backend-e100d7fddae1.herokuapp.com/donController/updateDonor", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "site-admin-pass": password
    },
    body: JSON.stringify({
      id: donationId,
      status: newStatus
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error("Failed to update status");
    }
    return response.json();
  })
  .then(updatedDonation => {
    console.log("Status updated:", updatedDonation);
    const statusElement = document.getElementById(`status-${index}`);
    if (statusElement) {
      statusElement.textContent = `Status: ${newStatus}`;
      statusElement.className = `status ${newStatus.toLowerCase()}`;
    }
    
    // Show success message
    alert(`Donation marked as ${newStatus} successfully!`);
  })
  .catch(error => {
    console.error("Error updating status:", error);
    alert(`Failed to update status: ${error.message}`);
  });
}

function deleteDonor(donationId, index) {
  if (!confirm("Are you sure you want to mark this donation as incomplete and remove it?")) {
    return;
  }
  
  fetch("https://donation-site-backend-e100d7fddae1.herokuapp.com/donController/deleteDonor", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "site-admin-pass": password
    },
    body: JSON.stringify({
      id: donationId
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error("Failed to delete donation");
    }
    return response.json();
  })
  .then(result => {
    console.log("Donation deleted:", result);
    // Remove the transaction from the UI
    const transactionElement = document.querySelector(`#status-${index}`).closest('.transaction');
    if (transactionElement) {
      transactionElement.remove();
    }
    alert("Donation marked as incomplete and removed successfully!");
  })
  .catch(error => {
    console.error("Error deleting donation:", error);
    alert(`Failed to delete donation: ${error.message}`);
  });
}
</script>

</body>
</html>